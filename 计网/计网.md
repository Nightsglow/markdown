# 数据链路层

## 数据链路层功能

1. 为网络层提供服务：无确认无连接、有确认无连接、有确认有连接（建立、传输、释放）	
2. 链路管理：连接的建立、维持、释放，主要用于面向连接
3. 帧定界、帧同步、透明传输；**HDLC**就是一种面向比特的网络节点之间同步传输数据的**数据链路层**协议，标识位F(01111110)标识帧的开始和结束
4. 流量控制（OSI体系结构中）：限制发送方的数据流量，使其发生速率不超过接收方的接收能力(数据链路层点到点，传输层端到端)
5. 差错控制：位错、帧错(丢失、重复、失序等)；循环冗余校验(CRC)、自动重传请求(ARQ)；定时器、编号机制，保证每一帧最终都能仅有一次正确地交付给目的节点。

## 组帧

### 字符计数法

### 字符填充的首尾定界符法

控制字符SHO开始，控制字符EOT结束，转义字符ESC(以实现数据的透明传输)

### 零比特填充的首尾标志法

01111110来标志一帧的开始和结束，遇到五个连续的1时插入一个0 (以实现数据的透明传输)

### 违规编码法

物理层进行比特编码时常采用
例如曼彻斯特编码的1为“高低”，0为“低高”，对于“高高”、“低低”是违规的，可以用来这些违规编码序列来定界帧的起始和终止
实现了透明传输、只适用于采样冗余编码的特殊编码环境

## 差错控制

### 检错编码

冗余编码技术

#### 奇偶校验码

奇校验码：在附加一个校验元后，码长为n的码字中“1”的个数为奇数

#### 循环冗余校验码（CRC)

帧检验序列(FCS)
多项式G(X)，最高位和最低为必须为1，阶为r
计算步骤：低位附加r个0后模2除得到的余数即为冗余码r位
检验步骤：除后无余数则

### 纠错编码

#### 海明码

从右开始数第1、2、4、8、……、2^i^位为检错码
S1负责二进制中最低第一位为1位子的检验，S2负责二进制中最低第二位为1位子的检验（模2加）

## 流量控制和可靠传输机制

### 流量控制、可靠传输、滑动窗口机制

#### 停止-等待

#### 滑动窗口

发送端收到一个确认帧，窗口就向前滑动一个帧的位置
接收端收到数据帧后，将窗口前移一个位置
数据链路层的滑动窗口大小在传输过程中是固定的

#### 可靠传输

确认、超时重传
捎带确认
自动重传请求ARQ：停止-等待ARQ、后退N帧ARQ、选择性重传ARQ
后两种为连续ARQ协议
停等：信道利用率低，确认帧ACK
后退N帧ARQ：累计确认、若采用n比特对帧编号则发送窗口尺寸不能大于2^n^-1，否则造成接收方无法辨别新旧帧
选择性重传ARQ：窗口大小Wr=Wt=2^n-1^、否定帧NAK
								信道利用率：(L/C)/T，L比特数据，传输速率C，发送周期T
								信道吞吐率：信道利用率*发送方发送速率

## 介质访问控制（MAC）

方法：静态划分信道（信道划分介质访问控制）、动态（随机访问介质访问控制、轮询访问介质访问控制）

### 信道划分介质访问控制

分时、分频、分码

频分多路复用（FDM）

时分多路复用（TDM） ，可用于数字传输，而FDM不行

统计时分多路复用（STDM）动态分配时隙

波分多路复用（WDM）光的频分多路复用

码分多路复用（CDM） 码分多址（CDMA）各站点的码片序列相互正交，用A站点的码内积结果为1-》1，-1》0

### 随机访问介质访问控制

不采用集中控制、占用信道全部速率，会产生碰撞、重传帧

常用协议：ALOHA协议、CSMA协议、CSMA/CD协议、CSMA/CA协议等、

争用型协议：胜利者通过争用获得信道

实际上是一种将广播信道转化为点到点信道的行为

#### ALOHA协议

1、纯ALOHA协议

直接发，一段时间每收到确认就认为冲突了，等待一段时间后重新发，直至成功，吞吐率低

网络负载为G，则其吞吐量S=Ge^-2G^，G=0.5时，S约等于0.184，这时可能达到极大值

2、时隙ALOHA协议

划分时隙，只能时隙开始时才能发送一个帧。

时隙长度使得每个帧正好在一个时隙内发送完毕，每个帧到达后一般要在缓存中等待等待一段小于时隙的时间。

碰撞后重传的策略与纯ALOHA相同。

吞吐量S=Ge^-G^，比纯ALOHA大了一倍

#### CSMA协议

发送前监听一下共用信道，发现信道空闲后再发送

1、1-坚持CSMA

一个结点要发送数据时，首先监听信道

如果信道空闲，立即发送

如果忙，那么等待，同时继续监听直到信道空闲

如果发生冲突，那么随机等待一段时间后，再重新开始监听信道

传播延迟对其影响很大

2、非坚持CSMA

发送时，首先监听

如果空闲，立即发送

如果忙，放弃监听，等待一个随机的时间后再重复该过程

增加了数据在网络中的平均延迟

3、p-坚持CSMA

用于时分信道

发送时，首先监听

忙则持续监听直到空闲

空闲则以概率p发送，以概率1-p推迟到下一个时隙

下一个时隙同样，过程持续到发送成功或检测到忙，若是忙，则等待下一个时隙重新开始监听

是前两者的折中

#### CSMA/CD

适用于总线形网络、或半双工网络环境。（由于全双工采用两条信道，分别用来发送和接收，不可能产生冲突，故全双工不需要该协议）

CSMA/CD已成功应用于使用有线连接的局域网

**碰撞检测（CD）**

先听后发、边听边发、冲突停发、随机重发

采用CSMA/CD协议的以太网只能进行半双工通信

**单程传播时延t**，则把以太网端到端往返时间**2t**称为**争用期**，只有在争用期才会发送冲突

最小帧长=总线传播时延\*数据传输速率\*2

以太网规定取51.2us为争用期长度，对于10Mb/s的以太网，争用期可发送64B，因此**以太网规定最短帧长64B**，小于64B的帧都是由于冲突而异常终止的无效帧，应立即丢弃。若数据小于64B,则需要在MAC子层中于数据字段的后面加入一个整数字节的填充字段。

CSMA/CD还能从冲突中恢复
**截断二进制指数退避算法：**
确定基本退避时间：2t(即争用期)
参数k，重传次数，k不超过10，k=min[重传次数，10]
从离散的整数集合[0,1,……,2^k^-1]中随机去一个数r，重传所需的退避时间就是r倍的基本退避时间即r*2t
当重传达到16次仍不成功时，说明网络太挤，认为此帧永远无法正确发出，抛弃此帧，并向高层报告出错
在争用期检测到碰撞时立即停止发送，执行指数退避算法

#### CSMA/CA

无线局域网环境下：
①接收信号强度往往小于发送且无线介质上信号强度动态变化范围很大，若实现碰撞检测，则硬件上的花费很大；
②无线通信中中，并非所有的站点都能够听到对方，即存在"隐蔽站"问题。

802.11标准定义了广泛应用于无线局域网的CSMA/CA协议，相对CSMA/CD将碰撞检测改为了**碰撞避免（CA）**

802.11使用链路层确认/重传(ARQ)方案

为了尽量避免碰撞，802.11规定，所有的站点完成发送后，必须在等待一段很短的时间（继续监听）才能发送下一帧，这段时间称为**帧间间隔（IFS）**，帧间间隔的长短取决于该站要发送的帧的类型：
①SIFS(短IFS)：最短的IFS,用来分隔属于一次对话的各帧，使用SIFS的帧类型有ACK帧、CTS帧、分片后的数据帧、以及所有回答AP轮询的帧等
②PIFS(点协调IFS)：中等长度的IFS，在PCF操作中使用
③DIFS(分布式协调IFS)：最长的IFS，用于异步帧竞争访问的时延
![image-20231019220044070](assets/image-20231019220044070.png)

CSMA/CA的退避算法和CSMA/CD 的稍有不同(见教材)。信道从忙态变为空闲态时，任何一个站要发送数据帧，不仅都要等待一个时间间隔，而且要进入争用窗口，计算随机退避时间以便再次试图接入信道，因此降低了碰撞发生的概率。

当且仅当检测到信道空闲且这个数据帧是要发送的第一个数据帧时，才不使用退避算法。其他所有情况都必须使用退避算法，具体为:
在发送第一个帧前检测到信道忙
每次重传
每次成功发送后要发送下一帧。

CSMA/CA算法的归纳如下:
1)若站点最初有数据要发送(而不是发送不成功再进行重传)，且检测到信道空闲，在等待时间DIFS后，就发送整个数据。
2)否则，站点执行CSMA/CA 退避算法，选取一个**随机回退值**。一旦检测到信道忙，**退避计时器**就保持不变。只要信道空闲，退避计时器就进行倒计时。
3)当退避计时器减到0时(这时信道只可能是空闲的)，站点就**发送整个帧并等待确认**。
4)发送站若收到确认，就知道已发送的帧被目的站正确接收。这时如果要发送第二帧，就要从步骤 2)开始，执行 CSMA/CA 退避算法，随机选定一段退避时间。
若发送站在规定时间(由重传计时器控制) 内没有收到**确认帧 ACK**，就必须**重传**该帧，再次使用 CSMA/CA 协议争用该信道，直到收到确认，或经过若干次重传失败后放弃发送。

**隐蔽站问题**：站A和B都在 AP 的覆盖范围内，但A和B 相距较远，彼此都听不见对方，当A和B 检测到信道空闲时，都向 AP 发送数据，导致碰撞的发生。
为了避免该问题，802.11 允许发送站对信道进行预约。
**源站**要发送数据帧之前先**广播**一个很短的**请求发送 RTS (Request To Send) 控制**，它包括源地址、目的地址和这次通信(含相应的确认帧) 所持续的时间，该能被其范围内包括 AP 在内的所有站点听到。
若信道空闲，则**AP广播**一个**允许发送 CTS (Clear To Send) 控制**，它包括这次通信所需的持续时间(从RTS 帧复制),该帧也能被其范围内包括 A 和 B 在内的所有站点听到。B 和其他站听到 CTS 后在 CTS 中指明的时间内将**抑制发送**。**CTS 有两个目的:①给源站明确的发送可;②指示其他站点在预约期内不要发送**

#### CSMA/CD与 CSMA/CA 区别:

1、CSMA/CD 可以检测冲突，但无法避免;CSMA/CA 发送数据的同时不能检测信道上有无冲突，本结点处没有冲突并不意味着在接收结点处就没有冲突，只能尽量避免。
2、传输介质不同。CSMA/CD 用于总线形以太网，CSMA/CA 用于无线局域网 802.1la/b/g/n 等
3、检测方式不同。CSMA/CD 通过电缆中的电压变化来检测:而 CSMA/CA 采用能量检测载波检测和能量载波混合检测三种检测信道空闲的方式。
总结:
**CSMA/CA 协议的基本思想是在发送数据时先广播告知其他结点，让其他结点在某时间内不要发送数据，以免出现碰撞。**
**CSMA/CD 协议的基本思想是发送前监听，边发送边监听旦出现碰撞马上停止发送。**

### 轮询访问：令牌传递协议

令牌（Token）沿着环形总线在各节点计算机之间一次传递。
令牌是一个特殊的MAC控制帧
令牌传递到有数据要发送的站点时，该站点修改令牌中的一个标志位并附加需要传输的数据，将令牌变为一个数据帧发出，数据帧沿环路传输。
接收站点一边转发一边查看帧的目的地址，若目的地址时自己那么接收站复制该数据。
数据帧沿着换路传输，直到到达源点。通过检验返回的帧来检测是否出错
传送完，重新产生一个令牌，并传递给下一个站点，以交出信道控制权。
令牌环网不会发送碰撞

物理拓扑不必是环，令牌在设备间的传递通路逻辑上必须是个环。

非常适合负载很高的广播信道