# 数据链路层

## 数据链路层功能

1. 为网络层提供服务：无确认无连接、有确认无连接、有确认有连接（建立、传输、释放）	
2. 链路管理：连接的建立、维持、释放，主要用于面向连接
3. 帧定界、帧同步、透明传输；**HDLC**就是一种面向比特的网络节点之间同步传输数据的**数据链路层**协议，标识位F(01111110)标识帧的开始和结束
4. 流量控制（OSI体系结构中）：限制发送方的数据流量，使其发生速率不超过接收方的接收能力(数据链路层点到点，传输层端到端)
5. 差错控制：位错、帧错(丢失、重复、失序等)；循环冗余校验(CRC)、自动重传请求(ARQ)；定时器、编号机制，保证每一帧最终都能仅有一次正确地交付给目的节点。

## 组帧

### 字符计数法

### 字符填充的首尾定界符法

控制字符SHO开始，控制字符EOT结束，转义字符ESC(以实现数据的透明传输)

### 零比特填充的首尾标志法

01111110来标志一帧的开始和结束，遇到五个连续的1时插入一个0 (以实现数据的透明传输)

### 违规编码法

物理层进行比特编码时常采用
例如曼彻斯特编码的1为“高低”，0为“低高”，对于“高高”、“低低”是违规的，可以用来这些违规编码序列来定界帧的起始和终止
实现了透明传输、只适用于采样冗余编码的特殊编码环境

## 差错控制

### 检错编码

冗余编码技术

#### 奇偶校验码

奇校验码：在附加一个校验元后，码长为n的码字中“1”的个数为奇数

#### 循环冗余校验码（CRC)

帧检验序列(FCS)
多项式G(X)，最高位和最低为必须为1，阶为r
计算步骤：低位附加r个0后模2除得到的余数即为冗余码r位
检验步骤：除后无余数则

### 纠错编码

#### 海明码

从右开始数第1、2、4、8、……、2^i^位为检错码
S1负责二进制中最低第一位为1位子的检验，S2负责二进制中最低第二位为1位子的检验（模2加）

**汉明距离**

两个(相同长度)字的汉明距离是对应位不同的数量。我们以d (x , y) 表示两个字x和 y之间的汉明距离。
![image-20231021205649895](assets/image-20231021205649895.png)

**最小汉明距离**(minimum Hamming distance) 是所有可能对中的最小仅明距离。

**如果我们的编码能检测出最多s个差错，那么两个有效编码间的最小汉明距离必须是s+1 ,这样接收到的码字才不会与有效码字匹配。换言之，如果所有有效码宇间的最小距离是s+1 ，那么接收到的码字不会被错误地认为是另 一个正确的码字。距离小于(s+ 1) 码字接收方不会认为是有效码字 。 差错可以被检测到。**

**为了保证检测出所有情况下最多 s个差错，块编码中最小汉明距离一定是s+1 。**

**为了保证纠正所有情况下最多 t个差错，块钱码中的最小汉明距离是2t+1 。**

![image-20231021210630544](assets/image-20231021210630544.png) d~min~=3 。这个编码能检测到最多 2个差错

![image-20231021210703249](assets/image-20231021210703249.png)最小汉明距离是2。这个编码方案保证检测到单个差错 。

## 流量控制和可靠传输机制

### 流量控制、可靠传输、滑动窗口机制

#### 停止-等待

#### 滑动窗口

发送端收到一个确认帧，窗口就向前滑动一个帧的位置
接收端收到数据帧后，将窗口前移一个位置
数据链路层的滑动窗口大小在传输过程中是固定的

#### 可靠传输

确认、超时重传
捎带确认
自动重传请求ARQ：停止-等待ARQ、后退N帧ARQ、选择性重传ARQ
后两种为连续ARQ协议
停等：信道利用率低，确认帧ACK
后退N帧ARQ：累计确认、若采用n比特对帧编号则发送窗口尺寸不能大于2^n^-1，否则造成接收方无法辨别新旧帧
选择性重传ARQ：窗口大小Wr=Wt=2^n-1^、否定帧NAK
								信道利用率：(L/C)/T，L比特数据，传输速率C，发送周期T
								信道吞吐率：信道利用率*发送方发送速率

## 介质访问控制（MAC）

方法：静态划分信道（信道划分介质访问控制）、动态（随机访问介质访问控制、轮询访问介质访问控制）

### 信道划分介质访问控制

分时、分频、分码

频分多路复用（FDM）

时分多路复用（TDM） ，可用于数字传输，而FDM不行

统计时分多路复用（STDM）动态分配时隙

波分多路复用（WDM）光的频分多路复用

码分多路复用（CDM） 码分多址（CDMA）各站点的码片序列相互正交，用A站点的码内积结果为1-》1，-1》0

### 随机访问介质访问控制

不采用集中控制、占用信道全部速率，会产生碰撞、重传帧

常用协议：ALOHA协议、CSMA协议、CSMA/CD协议、CSMA/CA协议等、

争用型协议：胜利者通过争用获得信道

实际上是一种将广播信道转化为点到点信道的行为

#### ALOHA协议

1、纯ALOHA协议

直接发，一段时间每收到确认就认为冲突了，等待一段时间后重新发，直至成功，吞吐率低

网络负载为G，则其吞吐量S=Ge^-2G^，G=0.5时，S约等于0.184，这时可能达到极大值

2、时隙ALOHA协议

划分时隙，只能时隙开始时才能发送一个帧。

时隙长度使得每个帧正好在一个时隙内发送完毕，每个帧到达后一般要在缓存中等待等待一段小于时隙的时间。

碰撞后重传的策略与纯ALOHA相同。

吞吐量S=Ge^-G^，比纯ALOHA大了一倍

#### CSMA协议

发送前监听一下共用信道，发现信道空闲后再发送

1、1-坚持CSMA

一个结点要发送数据时，首先监听信道

如果信道空闲，立即发送

如果忙，那么等待，同时继续监听直到信道空闲

如果发生冲突，那么随机等待一段时间后，再重新开始监听信道

传播延迟对其影响很大

2、非坚持CSMA

发送时，首先监听

如果空闲，立即发送

如果忙，放弃监听，等待一个随机的时间后再重复该过程

增加了数据在网络中的平均延迟

3、p-坚持CSMA

用于时分信道

发送时，首先监听

忙则持续监听直到空闲

空闲则以概率p发送，以概率1-p推迟到下一个时隙

下一个时隙同样，过程持续到发送成功或检测到忙，若是忙，则等待下一个时隙重新开始监听

是前两者的折中

#### CSMA/CD

适用于总线形网络、或半双工网络环境。（由于全双工采用两条信道，分别用来发送和接收，不可能产生冲突，故全双工不需要该协议）

CSMA/CD已成功应用于使用有线连接的局域网

**碰撞检测（CD）**

先听后发、边听边发、冲突停发、随机重发

采用CSMA/CD协议的以太网只能进行半双工通信

**单程传播时延t**，则把以太网端到端往返时间**2t**称为**争用期**，只有在争用期才会发送冲突

最小帧长=总线传播时延\*数据传输速率\*2

以太网规定取51.2us为争用期长度，对于10Mb/s的以太网，争用期可发送64B，因此**以太网规定最短帧长64B**，小于64B的帧都是由于冲突而异常终止的无效帧，应立即丢弃。若数据小于64B,则需要在MAC子层中于数据字段的后面加入一个整数字节的填充字段。

CSMA/CD还能从冲突中恢复
**截断二进制指数退避算法：**
确定基本退避时间：2t(即争用期)
参数k，重传次数，k不超过10，**k=min[重传次数，10]**
从离散的整数集合[0,1,……,2^k^-1]中随机去一个数r，重传所需的退避时间就是r倍的基本退避时间即r*2t
当重传达到**16次**仍不成功时，说明网络太挤，认为此帧永远无法正确发出，抛弃此帧，并向高层报告出错
在争用期检测到碰撞时立即停止发送，执行指数退避算法

#### CSMA/CA

无线局域网环境下：
①接收信号强度往往小于发送且无线介质上信号强度动态变化范围很大，若实现碰撞检测，则硬件上的花费很大；
②无线通信中中，并非所有的站点都能够听到对方，即存在"隐蔽站"问题。

802.11标准定义了广泛应用于无线局域网的CSMA/CA协议，相对CSMA/CD将碰撞检测改为了**碰撞避免（CA）**

802.11使用链路层确认/重传(ARQ)方案

为了尽量避免碰撞，802.11规定，所有的站点完成发送后，必须在等待一段很短的时间（继续监听）才能发送下一帧，这段时间称为**帧间间隔（IFS）**，帧间间隔的长短取决于该站要发送的帧的类型：
①SIFS(短IFS)：最短的IFS,用来分隔属于一次对话的各帧，使用SIFS的帧类型有ACK帧、CTS帧、分片后的数据帧、以及所有回答AP轮询的帧等
②PIFS(点协调IFS)：中等长度的IFS，在PCF操作中使用
③DIFS(分布式协调IFS)：最长的IFS，用于异步帧竞争访问的时延
![image-20231019220044070](assets/image-20231019220044070.png)

CSMA/CA的退避算法和CSMA/CD 的稍有不同(见教材)。信道从忙态变为空闲态时，任何一个站要发送数据帧，不仅都要等待一个时间间隔，而且要进入争用窗口，计算随机退避时间以便再次试图接入信道，因此降低了碰撞发生的概率。

当且仅当检测到信道空闲且这个数据帧是要发送的第一个数据帧时，才不使用退避算法。其他所有情况都必须使用退避算法，具体为:
在发送第一个帧前检测到信道忙
每次重传
每次成功发送后要发送下一帧。

CSMA/CA算法的归纳如下:
1)若站点最初有数据要发送(而不是发送不成功再进行重传)，且**检测到信道空闲，在等待时间DIFS后，就发送整个数据**。
2)否则，站点执行CSMA/CA 退避算法，选取一个**随机回退值**。一旦检测到信道忙，**退避计时器**就保持不变。只要信道空闲，退避计时器就进行倒计时。
3)当退避计时器减到0时(这时信道只可能是空闲的)，站点就**发送整个帧并等待确认**。
4)发送站若收到确认，就知道已发送的帧被目的站正确接收。这时如果要发送第二帧，就要从步骤 2)开始，执行 CSMA/CA 退避算法，随机选定一段退避时间。
若发送站在规定时间(由重传计时器控制) 内没有收到**确认帧 ACK**，就必须**重传**该帧，再次使用 CSMA/CA 协议争用该信道，直到收到确认，或经过若干次重传失败后放弃发送。

**隐蔽站问题**：站A和B都在 AP 的覆盖范围内，但A和B 相距较远，彼此都听不见对方，当A和B 检测到信道空闲时，都向 AP 发送数据，导致碰撞的发生。
为了避免该问题，802.11 允许发送站对信道进行预约。
**源站**要发送数据帧之前先**广播**一个很短的**请求发送 RTS (Request To Send) 控制**，它包括源地址、目的地址和这次通信(含相应的确认帧) 所持续的时间，该能被其范围内包括 AP 在内的所有站点听到。
若信道空闲，则**AP广播**一个**允许发送 CTS (Clear To Send) 控制**，它包括这次通信所需的持续时间(从RTS 帧复制),该帧也能被其范围内包括 A 和 B 在内的所有站点听到。B 和其他站听到 CTS 后在 CTS 中指明的时间内将**抑制发送**。**CTS 有两个目的:①给源站明确的发送可;②指示其他站点在预约期内不要发送**

#### CSMA/CD与 CSMA/CA 区别:

1、CSMA/CD 可以检测冲突，但无法避免;CSMA/CA 发送数据的同时不能检测信道上有无冲突，本结点处没有冲突并不意味着在接收结点处就没有冲突，只能尽量避免。
2、传输介质不同。CSMA/CD 用于总线形以太网，CSMA/CA 用于无线局域网 802.1la/b/g/n 等
3、检测方式不同。CSMA/CD 通过电缆中的电压变化来检测:而 CSMA/CA 采用能量检测载波检测和能量载波混合检测三种检测信道空闲的方式。
总结:
**CSMA/CA 协议的基本思想是在发送数据时先广播告知其他结点，让其他结点在某时间内不要发送数据，以免出现碰撞。**
**CSMA/CD 协议的基本思想是发送前监听，边发送边监听旦出现碰撞马上停止发送。**

### 轮询访问：令牌传递协议

令牌（Token）沿着环形总线在各节点计算机之间一次传递。
令牌是一个特殊的MAC控制帧
令牌传递到有数据要发送的站点时，该站点修改令牌中的一个标志位并附加需要传输的数据，将令牌变为一个数据帧发出，数据帧沿环路传输。
接收站点一边转发一边查看帧的目的地址，若目的地址时自己那么接收站复制该数据。
数据帧沿着换路传输，直到到达源点。通过检验返回的帧来检测是否出错
传送完，重新产生一个令牌，并传递给下一个站点，以交出信道控制权。
令牌环网不会发送碰撞

物理拓扑不必是环，令牌在设备间的传递通路逻辑上必须是个环。

非常适合负载很高的广播信道

## 局域网（LAN）

### 基本概念和体系结构

是指在一个较小的地理范围内，将各种计算机、外部设备、数据库系统等通过双绞线、同轴电缆等连接介质相互连接起来，组成资源和信息共享的计算机互连网络。

特点：

1. 为一个单位所有，且地理范围和站点数目有限
2. 所有站点共享较高的总带宽（即较高的数据传输速率）
3. 较低的时延和较低的误码率
4. 各站点为平等关系而非主从关系
5. 能进行**广播和组播**

由三个要素决定：拓扑结构、传输介质、介质访问控制方式（最重要）

可以使用双绞线、铜缆、光纤等多种传输介质，双绞线为主流

拓扑结构：星型结构、环形结构、总线型结构、星型和总线型结合的复合结构

介质访问控制方式：CSMA/CD、令牌总线和令牌环。前两者主要用于总线型局域网，令牌环主要用于环形局域网

三种特殊局域网拓扑实现：
以太网：逻辑拓扑是总线形结构，物理拓扑是星型或拓展星型结构
令牌环：逻辑拓扑是环形结构，物理拓扑是星型结构
FDDI：逻辑拓扑是环形结构，物理拓扑是双环结构

IEEE 802标准定义的局域网，参考模型只对于OSI模型的数据链路层和物理层，并将数据链路层拆分为两个子层：**逻辑链路控制层（LLC）子层**和**媒体接入控制（MAC）子层**

媒体接入控制（MAC）子层：与接入传输体有关的内容都放在 MAC 子层，它向上层屏蔽对物理层访问的各种差异，提供对物理层的统一访接口，主要功能包括: **组帧和拆卸帧、比特传输、差错检测、透明传输**

逻辑链路控制层（LLC）子层：LLC 子层与传输媒体无关，它向网络层提供无确认无连接、面向连接、带确认无连接、高速传送 4 种不同的连接服务类型

LLC子层作用已经不大，现在许多网卡仅装有MAC协议

### 以太网与IEEE 802.3

IEEE 802.3 标准是一种基带总线形的局域网标准，它描述**物理层和数据链路层的 MAC 子层**的实现方法

以太网逻辑上采用总线形拓扑结构，以太网中的所有计算机共享同一条总线，**信息以广播方式发送**

为了保证数据通信的方便性和可靠性，以太网简化了通信流程并**使用了 CSMA/CD 方式对总线进行访问控制**

通常将 802.3 局域网简称为以太网

以太网采用两项措施以简化通信：
①采用**无连接**的工作方式，不对发送的数据编号(无编号)，也不要求接收方发送确认(无确认)，即以太网**尽最大努力交付数据，提供的是不可靠服务**，对于差错的纠正则由高层完成
②发送的数据都使用**曼彻斯特编码**的信号，每个码元的中间出现一次电压转换，接收端利用这种电压转换方便地把位同步信号提取出来。

#### 介质与网卡

以太网常用介质有四种：粗缆、细缆、双绞线和光纤

![image-20231020111228454](assets/image-20231020111228454.png)

星型网中心为集线器

网络接口板（又叫网络适配器、网络接口卡NIC），**网卡**上装有**处理器和存储器**，是工作在**数据链路层**的网络组件

网卡和局域网的通信是通过电缆或双绞线以串行方式进行的，而网卡和计算机的通信则是通过计算机主板上的 I/ 总线以并行方式进行的。

网卡的重要功能就是进行**数据的串并转换**。**网卡不仅能实现与局域网传输介质之间的物理连接和电信号匹配，还涉及帧的发送与接收、帧的封装与拆封、介质访问控制、数据的编码与解码及数据缓存功能等。**

全世界的每块网卡在出厂时都有一个唯一的代码，称为**介质访问控制(MAC)地址**，这个地用于控制主机在网络上的数据通信。
数据链路层设备(网桥、交换机等)都使用各个网卡的 MAC地址。
另外，网卡控制着主机对介质的访问，因此**网卡也工作在物理层**，因为它只关注比特，而不关注任何地址信息和高层协议信息。

#### 以太网的MAC帧

**MAC地址长6字节（48位）**：如02-60-8c-e4-b1-21
高24位为厂商代码，低24为厂商自行分配的网卡序列号
由于**总线上使用的是广播信道**，网卡从网络上收到一个MAC帧，首先用**硬件检查MAC帧中的MAC地址**。如果是发往本站的帧就收下，否则丢弃。
**以太网MAC帧格式有两种标准：DIX Ethernet V2标准（即以太网V2标准，最常用）和IEEE 802.3标准**

**以太网V2标准的帧格式**：

![image-20231020112625731](assets/image-20231020112625731.png)

**前导码（8B）**：使接收端和发送端时钟同步。其中**前7B是前同步码**，用于快速实现MAC帧的比特同步；**最后1B是帧开始定界符**，表示后面的信息就是MAC帧，**MAC帧不需要帧结束符**（注意区分不是尾部）因为以太网在传输帧时，各帧之间必须有一定的间隙。因此，接收端只要找到帧开始定界符，其后面连续到达的比特流就都属于同一个MAC帧

**地址 6B**：通常使用**6B(48位)**地址（MAC地址），先是**目的地址**，后面是**源地址**

**类型：2B**，指出数据域中携带的数据应该交给哪个协议实体处理

**数据：46~1500字节**，包含高层的协议消息。最长1500字节时规定。
**由于CSMA/CD算法限制，以太网帧必须满足最小长度限制要求64字节，数据较少时必须加以填充（0~46字节）**
**MAC帧的首部和尾部一起的长度为18B**。

**校验码（FCS）**：**4字节，校验范围从目的地址段到数据段的末尾**，算法采用**32位循环冗余码(CRC)**，不但需要检验MAC帧的数据部分，还要检验目的地址、源地址和类型字段，但不比较前导码。

**802.3帧格式的不同之处**：**长度域**代替DIX Ethernet V2标准MAC帧格式中的类型域，指出数据域的长度。长度段最大值是1500，因此从1501到65535的值可用于类型段标识符。

#### 高速以太网

速率达到或超过100Mb/s

100BASE-T以太网，双绞线上传送100Mb/s基带信号的星型拓扑结构以太网，CSMA/CD协议（半双工时），全双工和半双工，802.3标准的MAC帧格式，保持最短帧不变，但将一个网段的最大电缆长度减小到100米，帧间隔从原来的9.6us变为0.96us。

吉比特以太网，千兆以太网，1Gb/s,全双工和半双工，802.3标准的MAC帧格式，CSMA/CD协议（半双工时），与10BASE-T和100BASE-T技术向后兼容。

10吉比特以太网，与10Mb/s、100Mb\s，1Gb\s以太网的帧格式相同。保留802.3标准规定的最小最大帧长，只使用光纤作为传输媒体，只工作在全双工

### IEEE 802.11无线局域网

#### 无线局域网的组成

无线局域网分为两大类：有固定基础设施的无线局域网、无固定基础设施的移动自组织网络。

1、有固定基础设施的无线局域网
有固定基础设施，无线局域网的**802.11系列协议**，包括802.11a/b/g/n等，
使用星型拓扑，其中心成为**接入点AP**，在MAC层使用**CSMA/CA协议**。
**使用802.11协议的局域网又称Wi-Fi**
802.11标准规定无线局域网的最小构件是**基本服务集BSS**，一个基本服务集包括一个接入点和若干移动站，各站在本BSS内之间通信，或与本BSS外部站的通信，都必须通过本BSS的AP。此处提到的AP就是基本服务集中的基站。
安装AP时必须**为该AP分配**一个**不超过32字节**的**服务集标识符SSID**和一个信道。SSID是指使用该AP的无线局域网的名字。
一个基本服务集覆盖的地理范围称为一个**基本服务区(BSA)**，无线局域网的基本服务区的范围直径一般**不超过100m**。
一个基本服务集可以是孤立的，也可以通过AP连接到一个**分配系统DS**，然后再连接到另一个基本服务集，就构成了一个**扩展的服务集（ESS）**,ESS还可以通过一种称为Portal(门户)的设备为无线用户提供有线连接的以太网的接入，门户的作用相当于一个网桥。

2、无固定基础设施移动自组织网络
自组网络（Ad Hoc 网络）
没有上述AP，各节点之间地位平等，中间结点都为转发结点，因此都具有路由器的功能
自组网络通常是这样构成的:一些可移动设备发现在它们附近还有其他的可移动设备，并且要求和其他移动设备进行通信。**自组网络中的每个移动站都要参与网络中其他移动站的路由的发现和维护**，同时由移动站构成的网络拓扑可能随时间变化得很快，因此在固定网络中行之有效的一些路由选择协议对移动自组网络已不适用，需引起特别的关注。
自组网络和移动 IP 并不相同。移动 IP 技术使漫游的主机可以用多种方法连接到因特网，其核心网络功能仍然是基于固定网络中一直使用的各种路由选择协议。而自组网络是把移动性扩展到无线领域中的自治系统，**具有自己特定的路由选择协议，并且可以不和因特网相连**。

#### 802.11局域网的MAC帧

三种类型：**数据帧、控制帧、管理帧。**
帧组成：
1、**MAC首部，共30字节**
2、**帧主体**，帧的数据部分，不超过2312字节。
3、**帧检验序列FCS是尾部，共4字节**
首部中最重要的是四个地址字段（都是MAC地址），地址4用于自组网络，前三个地址的内容取决于帧控制字段的“去往AP"和“来自AP"这两个字段的数值。
![image-20231020145545368](assets/image-20231020145545368.png)
![image-20231020145559531](assets/image-20231020145559531.png)

AP和路由器间传输，AP的802.3帧与802.11帧的转换
![image-20231020150518205](assets/image-20231020150518205.png)
![image-20231020150743985](assets/image-20231020150743985.png)

### VLAN的基本概念与基本原理

一个以太网是一个广播域。以太网中出现大量广播帧，特别是经常使用的ARP和DHCP协议；一个单位的不同部门共享一个局域网对信息保密和安全不利。

虚拟局域网VLAN，可以把一个较大的局域网分割成一些较小的与地理位置无关的逻辑上的VLAN，而**每一个VLAN是一个较小的广播域**。

802.3ac标准定义了支持VLAN的以太网帧格式的扩展。
插入一个**4字节的标识符（在源地址字段和类型字段之间），称为VLAN标签**，用来指明发送帧的计算机属于哪个虚拟网络。插入VLAN标签的帧称为802.1Q帧。
![image-20231020151343458](assets/image-20231020151343458.png)
由于VLAN帧的首部增加了4字节，因此以太网的最大帧长从原来的1518字节变为1522字节。
VLAN标签的前两个字节置为**0x8100**，表示这是一个802.1Q帧。
在VLAN标签的后两个字节中，前4位没用，后12位是该**VLAN的标识符VID**
**交换机，插入VID后，802.1Q帧的FCS必须重新计算**

虚拟局域网只是局域网给用户提供的**一种服务**，并不是一种新型局域网

处于不同VLAN，即不同网络中，需要通过上层的路由器来解决，也可以在交换机中嵌入专用的芯片来进行转发，这样就在交换机中实现的第三层的转发功能。
二层交换机工作原理：当一个数据包到达二层交换机时，该交换机会查找目标 MAC 地址，并将其与内部的 MAC 地址表进行匹配，如果找到匹配项，则从相应的端口向外转发数据包。如果未找到匹配项，则会将数据包广播给所有连接的端口。

## 广域网

通常指覆盖范围很广（远超一个城市的范围）的长距离网络；是因特网的核心部分，其任务是长距离运送主机所发送的数据。

局域网可以通过广域网与另一个相隔较远的局域网通信。

广域网由一些**结点交换机**及连接这些交换机的链路组成。结点交换机的功能是**将分组存储并转发**，结点之间都是点到点连接，但为了提高网络可靠性，通常一个结点交换机往往与多个结点交换机相连。

结点交换机，注意不是路由器，工作原理类似，都是用来转发分组，但结点交换机在单个网络中转发分组，路由器在多个网络构成的互联网中转发分组

**广域网使用的协议主要在网络层**

![image-20231020154128786](assets/image-20231020154128786.png)
广域网中的一个重要问题是**路由选择**和**分组转发**。
**路由选择协议**负责搜索分组从某个结点到目的结点的最佳传输路由，以便构造路由表，然后从路由表再构造出转发分组的转发表。
**分组是通过转发表进行转发的。**
常见的两种**广域网数据链路层协议是 PPP 协议和 HDLC 协议**。

### PPP协议

**点对点协议(PPP)**是使用串行线路通信的面向字节的协议。
设计的目的主要是**用来通过拨号或专线方式建立点对点连接发送数据，使其称为各种主机、网桥和路由器之间简单连接的一种共同解决方案。**

三个组成部分：

1. **链路控制协议（LCP）**：一种扩展链路控制协议，用于**建立、配置、测试和管理数据链路。**
2. **网络控制协议（NCP）**：PPP协议允许同时采用多种网络层协议，**每个不同的网络层协议要用一个相应的NCP来配置**
3. 一个将IP数据报封装到串行链路的方法。IP数据报在PPP帧中就是其信息部分，这个信息部分的长度受最大传送单元（MTU）的限制。

![image-20231020161540355](assets/image-20231020161540355.png)
PPP帧格式
前三个字段和最后两个字段和HDLC帧是一样的。
**标志字段(F)**仍为**7E（01111110)，前后各占1字节**，若他在信息部分出现，就必须做字节填充，使用的控制专业字符是7D(01111101)。
但在PPP帧中**地址字段(A)占1字节**，规定为0xFF，**控制字段(C)占1字节**，规定为0x03,两者的内容始终固定不变。
**PPP是面向字节的**，因而所有PPP帧的长度都是整数个字节。
第四个字段是**协议段**，2字节，在HDLC中没有协议段
第五段**信息段的长度是可变的，大于或等于0且小于或等于1500B**.
第六段是**帧检验序列(FCS)，占2字节**，循环冗余检验(CRC)，检验区间包括**地址字段、控制字段、协议字段、信息字段**

当线路处于**静止状态**时，不存在物理层连接。当线路**检测到载波信号时，建立物理连接**，线路变为**建立状态**。此时，**LCP 开始选项商定**，商定成功后就进入**身份验证**状态。身份验证通过后，进入**网络层协议状态**。这时，**采用NCP 配置网络层**，**配置成功后，进入打开状态，然后就可进行数据传输**。**当数据传输完成后线路转为终止状态。载波停止后则回到静止状态**

PPP 链路建立、使用、撤销所经历的状态图。
![a461256c9fed4684f642bd1ad79a0cde](assets/a461256c9fed4684f642bd1ad79a0cde.jpeg)

PPP协议的特点：
1)PPP **提供差错检测**但不提供纠错功能，只保证无差错接收 (通过硬件进行 CRC 校验)。它是**不可靠的传输协议**，因此也不使用序号和确认机制。
2)它仅支持点对点的链路通信，不支持多点线路。
3)PPP **只支持全双工**链路。
4)**PPP的两端可以运行不同的网络层协议**，但仍然可使用同一个 PPP 进行通信。
5)**PPP 是面向字节的**，当信息字段出现和标志字段一致的比特组合时，PPP 有两种不同的处理方法:**若PPP 用在异步线路(默认)，则采用字符填充法:若 PPP 用在 SONET/SDH等同步线路，则协议规定采用硬件来完成比特填充(和HDLC的做法一样)**。

PPP有两种鉴别协议**:口令鉴别协议（PAP）**和**查询握手鉴别协议（CHAP）**。

PAP口令鉴别协议(Password Authentication Protocol ,PAP) 是一个两步骤的简单鉴别过程。

1. 需要访问系统的用户发送一个鉴别身份(通常是用户名)和一个口令。

2. 系统检测身份和口令的合法性，并选择接收连接或拒绝连接。

CHAP查询握手鉴别协议(Challenge Handshake Authentication Protocol , CHAP) 是一个三步握手鉴别协议，比 PAP更具安全性。在这种方式下，口令是保密的，无需上线发送。
1. 系统发送给用户一个包含查询值(通常是一些字节)的查询分组。

2. 用户应用一项预定义功能，根据查询值和用户自身的口令产生一个结果。用户将结果放入一个响应分组发送给系统。
3. 系统同样操作。它应用同样的功能，使用户的口令(系统已知的)和查询值产生一个结果。如果这个结果与响应分组中发送的结果相同，访问被允许；否则，访问被拒绝。CHAP比 PAP安全得多，特别是当系统不断地更换查询值时。甚至当入侵者得知查询值和结果时，口令始终是保密的。图 11.37显示了分组及其如何被使用。

### HDLC协议

**高级数据链路控制（HDLC）协议**是**面向比特**的数据链路层协议

**报文可透明传输，比特填充5个连续的1立即在后面填入一个0，0比特插入法**

**全双工**

**CRC检验，对信息帧进行顺序编号**

**传输控制功能和处理功能分离，具有较大灵活性。**

HDLC帧格式：**标志F(01111110)，地址1B，控制1B，信息(可变)和FCS(2B)等字段**构成

![image-20231020165522401](assets/image-20231020165522401.png)


PPP 和 HDLC 的格式很相似。但两者有以下几点不同:
1) **PPP 协议**是面向**字节**的，**HDLC 协议**是面向**比特**的。
2) PPP 帧比HDLC 多一个2字节的**协议字段**。当协议字段值为 **0x0021 时，表示信息字段是IP 数据报**。
3) PPP 协议不使用序号和确认机制，只保证无差错接收(CRC 检验)，而端到端差错检测由高层协议负责。**HDLC 协议的信息帧使用了编号和确认机制，能够提供可靠传输。**

## 数据链路层设备

### 网桥

**两个或多个以太网通过网桥连接**后，就成为一个覆盖范围更大的以太网，而原来的每个以太网就称为一个网段。

**网桥**工作在**链路层的 MAC 子层，可以使以太网各网段成为隔离开的碰撞域(又称冲突域)**。如果把网桥换成工作在物理层的转发器，那么没有这种过滤通信量的功能。由于各网段相对独立，因此**一个网段的故障不会影响到另一个网段的运行**。
网桥必须具有**路径选择的功能**，接收到帧后，要决定正确的路径，将该帧转送到相应的目的局域网站点。

### 局域网交换机

也叫**以太网交换机**

实际上就是一个多端口的网桥，工作在**数据链路层**
通常工作在**全双工方式**。
能经济地将网络分成小的冲突域。

以太网交互机的原理：它检测从以太端口来的数据帧的源和目的地的MAC(介质访问层)地址，然后与系统内部的动态查找表进行比较，若数据帧的源MAC地址不在查找表中，则将该地址加入查找表，并将数据帧发送个相应的目的端口。

以太网交换机可以方便的实现虚拟局域网VLAN，**VLAN不仅可以隔离冲突域，还可以隔离广播域**。

对于传统10Mb/s的共享式以太网，若共有N个用户，则每个用户占用的平均带宽只有总带宽(10Mb/s)的1/N。在使用以太网交换机（默认工作在全双工）来连接这些主机，虽然在每个端口到主机的带宽还是10Mb/s，但由于一个用户在通信时独占而不是和其他用户共享传输媒体的带宽，因此用于N个端口的交换机的总容量为：N*10Mb/s，这是**交换机最大的优点**

以太网交换机的特点：

1. 以太网交换机的**每个端口都直接与单台主机相连**(网桥的端口往往连接到一个网段)，并且一般都工作在**全双工**方式。
2. 以太网交换机能同时连通多对端口，使每对相互通信的主机都能像独占通信媒体那样，**无碰撞地传输数据**。
3. 以太网交换机是一种即插即用设备，其内部的帧的**转发表**是通过**自学习算法**自动地逐渐建立起来的。
4. 太网交换机由于使用专用的交换结构芯片，**交换速率较高**
5. **以太网交换机独占传输媒体的带宽**

两种交换模式：

1. **直通式交换机**，只检查帧的目的地址，使得帧在接收后几乎能马上被传出去，**无法支持不同速率的端口的交换**
2. **存储转发式交换机**，先将接收到的帧缓存到高速缓存中，并检查数据是否正确，确认无误后通过查找表转换成输出端口将该帧发送出去。如果发现帧有错，那么就将丢弃。**优点：可靠性高，并能支持不同速率端口间的转换；缺点：延迟较大**。

**交换机的自学习功能：**

1. **过滤**：决定一个帧是应该转发到某个端口还是应该将其丢弃。
2. **转发**：决定一个帧应该被移动到哪个端口
3. 交换机的过滤和转发借助**交换表**完成，交换表的一个表项至少包含：①一个MAC地址；②连通该MAC地址的交换机端口。
4. A向B发送一帧，从端口1进入交换机，先查找交换表，若找不到MAC地址为B的表项。然后，交换机将该帧的源地址A和端口1写入交换表，并向除端口1外的所有端口广播这个帧。有表项时，则从对应端口转发。

**交换机和网桥的不同之处**。
尽管交换机也称多端口网桥，但两者仍有许多不同之处。主要包括以下三点:

1. 网桥的端口一般连接局域网，而交换机的端口一般直接与局域网的主机相连
2. 交换机允许多对计算机同时通信，而网桥仅允许每个网段上的计算机同时通信
3. 网桥采用存储转发进行转发，而以太网交换机还可以采用直通方式进行转发，且以太网交换机采用了专用的交换结构芯片，转发速度比网桥快。

## 广域网 SONET/SDH

广域网 SONET，用做承载来自其他WAN数据的传输网络

光纤的高带宽适用于今天的高数据速率技术(比如视频会议)和低速率下同时承载大量的数据。基于这个原因，光纤和要求高数据速率或者高带宽传输的技术共同发展。继而有了标准化的需要。因此，美国组织(ANSI)和欧洲组织(ITU-T) 定义了相应的标准，虽然两种标准是独立的，但是基本功能相似并且最终是兼容的。
ANSI标准成为**同步光纤网络(Synchronou Optical Network , SONET)** , ITU-T标准成为**同步数字体系(Synchronous digital Hierarchy , SDH) 。**
SONET 由 ANSI 定义。
SDH 由 ITU-T 定义。
**SONET/SDH是使用同步TDM多路复用的同步网络。系统中的所有时钟都锁定于主时钟。**

### 体系结构

#### 信号

**SONET**定义了称为**同步传输信号**(synchronous transport signal , **STS**) 的**电子信号等级体系**。每个 STS等级(STS-1 到 STS-192) 支持特定的数据速率(以每秒兆位规定) 。
相应的光信号称为**光载波**
**SDH**也规定了一个相似的系统，称为**同步传输模块(**synchronous transport module , **STM**)。
STM用于与现存欧洲体系(比如E线路)和STS等级兼容。最后，最低的 STM等级STM-1 定义为 155.520Mbps ，正好等同于 STS-3 。

![image-20231021212326551](assets/image-20231021212326551.png)

其次，STS-3的速率正好是STS-1 速率的三倍，STS-9的速率正好是STS-18速率的一半。这些关系意味着 18个 STS-1 通道能复用成一个STS-18通道，六个 STS-3通道能复用成一个STS-18通道，依此类推。

#### SONET设备

![image-20231021212823384](assets/image-20231021212823384.png)
SONET传输依靠三个基础设备**:STS 多路复用器(STS MUX)/分离器(STS DEMUX)、再生器(R)、分插复用器(ADM)和终端(T)。**

**STS 多路复用器/分离器**标记 SONET链路的开始点和结束点。提供电子支路网络和光网络之间的接口。
**STS 多路复用器**(STS multiplexer) **复用来自多个电子源的信号，井产生相应的 OC信号。**
**STS分离器**(STS demultiplexer) **将光OC信号分解成相应的电子信号。**

**再生器**扩展了链路的长度。再生器(regenerator )是个**中继器** ，它把接收到的光信号(OC-n) 解调成相应的电信号(STS-n) ， 再生成电信号，最后把电信号调制成相应的OC-n1信号。SONET再生器用新的信息替换一些现有的开销信息(头部信息)。

**分插复用器(add/drop multiplexer , ADM) ，分插复用器允许信号的插入和抽取**。可以把来自多个源的 STS加到给定路径中或是从某条路径中除去并重定向所需的信号，而无需多路分解整个信号。分插复用器使用诸如地址和指针(会在后面描述)的头部信息来确定单个流，而不是依靠时间和位置。

在上图所示的简单配置中，多个进入的电子信号输入一个 STS 多路复用器中，这些信号在多路复用器里组合成一个单一光信号。光信号传输给再生器，在这里重新生成不带有传输过程中加入的噪声的信号。从多个源再生的信号输入到一个分插复用器。分插复用器重新组织这些信号，如果需要，用数据帧中的信息将它们直接发送出去。这些再次多路复用的信号发送给另一个再生器，然后再发送给接收 STS分离器，在这里以接收链路可以接受的格式返回。

**终端(terminal )**是使用 SONET网络服务的设备。例如，在因特网中，终端可以是一个路由器，该路由器需要将发送分组给SONET网络另一端的另一个路由器上。

#### 连接

**段(section)** 是连接两个相邻设备(多路复用器到多路复用器、多路复用器到再生器、或再生器到再生器)的光链路。

**线路(line)** 是两个多路复用器之间(STS 多路复用器到分插复用器、两个分插复用器、或两个STS 多路复用器)的网络部分。

**路径(path)** 是两个 STS 多路复用器之间的端到端网络部分。在两个 STS 多路复用器直接互连的简单 SONET中，段、线路和路径相同。

### SONET 层

**SONET标准包括四个功能层:光子层、段层、线路层和路径层。它们对应于物理层和数据链路层。**
![image-20231021213854429](assets/image-20231021213854429.png)

#### 路径层

路径层(path layer) 负责将信号从它的光信源到光信宿的移动。在光信源，信号从电形式转换成光形式，再与其他信号复用在一起，封装成帧。在光信宿，接收到的帧被多路分解，然后将单个光信号转换回它们的电形式。在这一层增加了路径层开销。
STS多路复用器提供路径层功能。

#### 线路层

线路层(line layer) 负责信号在物理线路中的移动。这一层给帧增加线路层开销。
STS 多路复用器和分插复用器提供线路层功能。

#### 段层

段层(section layer) 负责信号在物理段中的移动。它处理成帧、串扰和差错控制。在这一层给帧增加段层开销。

#### 光子层

光子层(photonic layer) 对应于OSI模型中的物理层。它包括光纤通道、接收器敏感度、多路复用功能等等的物理规范说明。
SONET使用 NRZ进行编码，光存在为 1 ，不存在为0 。

#### 设备-层之间的关系

STS 多路复用器是四层设备。分插复用器是三层设备。再生器是两层设备。
![image-20231021214259289](assets/image-20231021214259289.png)

### SONET帧

**每个同步传输信号 STS-n 由 8000个帧组成。每个帧是个90*n列9行的两维矩阵。**例如，STS-1 帧有 90列、9行(810字节)，STS-3有 270列、9行(2430字节)。
![image-20231021214434944](assets/image-20231021214434944.png)

#### 帧、字节和位传输

**每个 STS-n信号以每秒 8000个帧的固定速率传输**。这是数字化语音的速率。对于每个帧，从左向右、从上到下传输字节。对于每个字节，从高位向低位(从左向右)传输位。
![image-20231021214625511](assets/image-20231021214625511.png)
如果我们对语音信号进行采样，每个样本 8位( 1 个字节) ，我们可以说SONET帧中的每个字节可以携带来自数字化语音通道的信息。换言之，**STS-1 信号能同时携带774个语音通道(810减去用于开销所需的字节)**。
**SONET帧中的每一个字节能承载一个数字化语音通道。**

#### STS-1 帧格式

![image-20231021214934624](assets/image-20231021214934624.png)

该帧的前三列用于段和线路开销。前三列的上面三行用于段开销(section overhead ,SOH) 。下面六行用于线路开销(l ine overhead , LOH) 。该帧的其他字节成为同步有效载荷封装(SPE) 。它包括用户数据和用户数据级别所需的路径开销(path overhead , POH) 

##### 段开销

**段开销**，每个段开销由 9个八位字节组成。这些八位字节的标签 、 功能和组织如图 17.7所示。

**对齐字节**(A1 和 A2) 。字节Al 和A2用于实现成帧和同步，称为对齐字节。这些字节向接收器告警有一个帧即将到边 ， 井给接收器一个预先确定的用于同步的位模式。这两个字节的位模式的十六进制为 OxF628 。这些字节充当标记。

**奇偶校验字节**(B1 )。字节 B1用于**位交织奇偶(BIP-8) 校验**。它的值由前一个帧所有字节计算而得。换言之，这个字节的第 i位是前一个STS-n帧的所有第i位计算而得的奇偶位。这个字节的值只放在 STS-n帧中的第一个 STS-1中。换言之，虽然一个 STS-n帧有n个B1字节(正如我们会在后面看到的) ，但是只有第一个字节有这个值，其余用0填充。

**标识字节**(C1)。字节C1携带了 STS-1 帧的标识。当多个 STS-1 帧复用生成更高速率STS帧(STS-3 、STS-9 、STS - 12等)的时候需要这个字节。这个字节中的信息允许在分解时能轻易辨认出各个信号。例如，在一个 STS-3信号中，对应第一个 STS-1的 Cl 字节的值是 1 ，第二个是 2 ，第三个是3 。

**管理字节**( D1、D2 、和 D3)。D1 、D2和 D3 字节一起形成一条称为数据通信通道的192kbps的通道(3 x 8000 x 8) 。这个通道用于操作、管理 、 和维护(OA&M) 信令。

**线路序列字节**(E 1)。字节目是线路序列字节。在连续帧中的El 字节形成了一条64kbps通道(每秒的 8000个帧乘以每个帧的 8位)。这个通道用于再生器之间、或终端和再生器之间的通信。

**用户字节**(F 1)。在连续帧中的 Fl 字节形成了一条 64kbps的通道，保留用于在段层的用户需求。
为每个SONET设备(再生器和多路复用器)重新计算段开销。

##### 线路开销

线路开销由 18个字节组成。这些字节的标签、功能和安排如图 17.8所示。
![image-20231021220005138](assets/image-20231021220005138.png)

**线路奇偶字节(B2)** 。字节 B2用于位交织奇偶校验。它用于线路上(两个多路复用器间)帧的差错检测。在一个STS-n帧中，为前一个
STS-1 帧中的所有字节计算B2 ，井插入到那个帧的 B2宇节中。换言之，在一个 STS-3 帧中，有三个 B2字节，每个都是为一个 STS-1
帧计算的。这个字节与段开销中的 Bl 字节相对应。

**数据通信通道字节**(04到 012) 。连续帧中的线路开销D字节(D4到 D12) 形成了一条576kbps的通道，该通道提供与 D1-D3字节(OA&M) 一样的服务，但是在线路级别而不是在段级别(两个多路复用器之间)。

**线路序列字节**(E2) 。连续帧中的E2字节形成了一条64kbps的通道，该通道提供与 E1线路序列字节一样的功能，只是应在线路级别。

**指针字节(H1 、H2和 H3)** 。字节H1、H2和H3是指针。前两个字节用于说明帧中 SPE的偏移量，第三个字节用于证明。我们会在后面说明这三个字节的用法。

**自动保护交换字节**(K1 和 K2) 。连续帧中的Kl 和K2字节形成了一条 128kbps的通道，用于在线路终止设备中的问题自动检测。我们会在本章后面讨论**自动保护交换(APS)** 。

**成长字节(Z1 和 Z2)** 。ZI 和Z2字节保留用于将来的使用。



##### 同步有效载荷封装（包含 路径开销）

**同步有效载荷封装( synchronous payload envelope , SPE)** 包含用户数据和与用户数据相关的开销(**路径开销**)。并不需要将一个 SPE恰好放入一个 STS-1 帧中，我们很快会看到它可以分成两个帧。这意味着路径开销(SPE的最左列)不需要与段开销或线路开销对齐。必须先把路径开销加到用户数据中生成 SPE ，然后将 SPE插入到一个或两个帧中。**路径开销由 9个字节组成**。这些字节的标签、功能和安排如
图 17.9所示。
![image-20231022093608475](assets/image-20231022093608475.png)
·**路径奇偶字节(B3)** 。字节B3用于位交织奇偶校验，像Bl 和B2一样，但是对 SPE位进行计算。它实际上是对流中前一个SPE进行计算。
·**路径信号标签字节(C2)** 。字节C2是路径标识字节。它用于确认 SPE中所携带数据在更高级(诸如 IP或ATM) 所使用的不同协议。
·**路径用户通道字节(F2)** 。连续帧中的F2字节，像Fl 字节一样，形成一条64kbps的通道，它保留用于用户需求，但在路径级别。
·**路径状态字节(G 1)**。字节Gl 由接收方发送给发送方来告知它的状态。当通信是多路复用时，它在保留通道上发送。我们会在本章后面看它用于线性或环网络。
·**多帧指示(H4)** 。字节H4是多帧指示。它说明无法放入单个帧的有效载荷。例如，虚拟辅助指示可以组合起来形成一个帧，它比 SPE帧更大、需要分成几个帧。会在下一节讨论虚拟辅助指示。
·**路径跟踪字节(J1 )**。连续帧中的 11 字节形成一条用于跟踪路径的 64kbps的通道。11 字节发送一个连续的64字节字符串来验证连接。字符串的选择留给应用程序。接收方会将每个模式与前一个比较来保证路径层上的通信没有错误。
·**成长字节(Z3 、Z4和Z5)** 。字节Z3 、Z4和Z5保留用于将来的使用。

**路径开销只为搞到端(在 STS 多路复用器之间)计算。**

##### 开销总结

![image-20231022093845675](assets/image-20231022093845675.png)

#### 封装

 SPE需要封装在 STS-1帧中。封装会产生两个问题，但 SONET可以使用指针(H1 到 H3) 很好地处理它们。

##### 偏移

SONET允许一个SPE扩展到两个帧， SPE的一部分在第一个帧中，另一部分在第二个帧中。
当要封装的一个 SPE与经过的同步帧在时间上不对齐时可能会发生这种情况。图 17.10显示了这种情况。
图中还显示了路径开销，它与任一个帧中的段/线路开销对齐。问题是SONET多路复用器如何知道在帧中哪里是 SPE的开始?哪里是结束?解决方能是使用指针 H1 和 H2来定义SPE的开始，因为每个 SPE有固定个字节数所以结束可以确定。SONET允许 SPE相对于 STS1 帧的偏移。

![image-20231022094102542](assets/image-20231022094102542.png)



为了找到帧中每个 SPE的开始，我们需要线路开销中的两个指针H1 和H2， 注意这些指针位于线路开销，因为封装发生在多路复用器中。图 17 . 11 显示这两个字节如何指向 SPE的开始 。注意我们需要2个字节来定义在帧中一个字节的位置，一个帧有 810个字节，因此不能用 1 个字节来定义 。
![image-20231022094220944](assets/image-20231022094220944.png)

### STS多路复用

在 SONET中，较低速率的帧会**同步地时分多路复用**到一个更高速率的帧中。例如，三个STS-1 信号(通道)可以组合成一个 STS-3信号(通道) ，四个 STS-3信号可以多路复用成一个STS-12信号，等等，如图 17 . 12所示。多路复用是同步TDM ，网络中的所有时钟都锁定一个主时钟来实现同步。在 SONET 中，网络中的所有时钟都锁定一个主时钟。

![image-20231022094714762](assets/image-20231022094714762.png)
多路复用也可以发生在更高的数据速率。例如，四个 STS-3信号可以多路复用成一个 STS-12信号。但是，STS-3信号需要先分离成 12个 STS-l 信号，然后这十二个信号再多路复用成一个 STS-12信号。这个额外工作的原因会在我们讨论字节交织后明了。

#### 字节交替

在 SONET 中**同步TDM 多路复用**通过**字节交替**(byte interleaving) 实现
例如，当 三个STS-l 信号多路复用成一个 STS-3信号时，STS-3信号中每组 3个字节与来自每个STS-1信号的 1个字节相关。图 17.13显示了交替。
![image-20231022094857326](assets/image-20231022094857326.png)

STS-l 帧的字节保持它的行位置，但是它移到不同的列 。 原因是所有信号帧都有相同的行数(9) ，而列数改变了 。STS -n信号帧中的列数是 STS-l 帧中列数的 n倍 。因此， STS-n帧的一行能够适应 STS1 帧的 n行 。

如图 17.14所示，字节交替还**保留了相应的段开销和线路开销** 。 来自三个 STS-1 帧的段开销交织在一起生成 STS-1帧的段开销。线路开销同理。但是，每个通道保留用来控制那个通道的相应字节。换言之，段和线路为每个多路复用通道保留它们自己的控制字节。这个有趣的
特性允许分插复用器的使用，这己简单讨论过。如图所示，有三个A1字节，每个A1字节属于三个被复用信号的每一个。同样有三个A2字节，三个A3字节。

这里的多路复用比第6章描述过的统计TDM容易，因为分离器除去第一个A1 并把它分给第一个 STS-1 、 除去第二个 A1并把它分给第二个 STS-1 、除去第三个 A1 并把它分给第三个STS-1，与字节的函数无关。换言之，**分离器仅仅处理字节的位置**，而不是它们的函数。
我们已经讲过的段开销和线路开销并不适用于路径开销。这是因为路径开销是 SPE的一部分，SPE可能已经分到两个 STS-1帧了。但是，字节交替与 SPE的数据部分相同。
字节交替过程使得可以更高的数据速率多路复用，但也更加复杂。我们如何把四个 STS-3信号多路复用成一个 STS-12信号呢?这可以通过两步做到:首先，必须先分解STS-3信号生成12个 STS-1 信号。然后这 12个 STS-1信号多路复用成一个STS-12信号。
![image-20231022095337207](assets/image-20231022095337207.png)

#### 重组信号

在 SONET的正常工作模式中 ， STS-n 信号由 n个多路复用的 STS-1信号组成。有时，我们有比 STS-1数据速率高的信号。这种情况下，SONET允许生成一个STS-n信号，它不被看做是n个STS-l 信号，它是不可以分解成n个 STS-l 信号的一个 STS-n信号(通道)。为了说明如何分解这个信号，后缀 c (用于说明重组)加到信号名后面。例如，STS-3c是不能分解成三个 STS-l 信号的信号。但是，我们需要知道一个 STS-3c信号中的整个有效载荷是一个 SPE ，这意味着我们**只有一列路径开销(9字节)**。这种情况使用的数据占用 260列，如图17.15所示。

![image-20231022095546954](assets/image-20231022095546954.png)

##### **携带ATM信元的重组信号**

**ATM网络是信元网络**，在ATM 网络中**每个信元有固定长度 53个字节**。一个 STS-3c信号的 SPE可以是ATM信元的承载者。
**一个 STS-3c信号的 SPE能携带9 x 260=2 340个字节，这大约于44个ATM信元(53个字节)。**

**一个STS-3c信号可以携带 44个ATM信元作为它的 SPE** 。

#### 分插复用器

将多个 STS-1信号多路复用成一个 STS-n信号，是在 STS 多路复用器中完成(在路径层)。STS-n信号分离成 STS-l 信号，是在 STS分离器中完成。
但是，在两者之间，SONET使用**分插复用器**，**它可以用一个信号替换另一个信号**。我们需要知道这不是传统意义上的分离/复用。
分插复用器工作在**线路层**。分插复用器不生成段、线路或路径开销。它几乎作为交换机，它除去一个 STS-l 信号，加上另一个STS-l 信号。分插复用器的输入和输出的信号类型相同(比如两个 STS-3或两个STS-12) 。分插复用器(ADM) 只除去相应的字节，然后用新的字节替换
它们(包括段开销和线路开销中的字节)。图 17.16显示ADM的工作机制。
![image-20231022095959629](assets/image-20231022095959629.png)

### SONET 网络

使用 SONET设备，我们可以建立一个 SONET网络，它可以用做承载来自诸如ATM(第 18章)或 IP(第20章)负载的高速骨干网。我们可以大把SONET分为三类:线状、环状和网状网络，如图 17.17所示。
![image-20231022100113319](assets/image-20231022100113319.png)

#### 线状网络

线状SONET网络可以是点到点的，也可以是多点的。

##### 点到点网络

**点到点网络**通常由一个 STS 多路复用器、一个 STS分离器、0个或更多再生器、无分插复用器组成，如图 17.18所示。信号流可以是单向的也可以是双向的，虽然图 17.18为了简单只显示了单向。
![image-20231022100155273](assets/image-20231022100155273.png)

##### 多点网络

**多点网络**使用 **分插复用器(ADM)**允许多个终端间的通信。 ADM除去属于连到它的终端的信号，井加上来自另一个终端的信号。每个终端可以发送数据给一个或多个下游终端。图 17.19显示了一个单向方案，在这个方案中每个终端可以只发送数据给下游终端，但多点网络也可以是双向的。
在图 17.19 中，Tl 同时发送数据给T2和T3. 但是T2只能发送数据给T3 。该图显示了一个简单的配置，在正常情况下我们可以有多个ADM以及更多的终端。
![image-20231022100312031](assets/image-20231022100312031.png)

##### 自动保护交换

**为了建立对线状网络中故障的保护**，SONET定义了**自动保护交换**(automatic protection switching , **APS**) 。
**线状网络中的APS定义在线路层**，这意味着保护是在两个ADM或一对 STS多路复用器/分离器之间。这个主意提供了**冗余性**。在发生故障的情况下可以使用一条冗余线路(光纤)。**主线路称为工作线路，冗余线路称为保护线路。**
在线状通道中通常有三种保护方案:一加一 、一到一和一到多。图 17 . 20显示这三种方案。
![image-20231022100534368](assets/image-20231022100534368.png)

###### 一加一APS

在这个方案中，通常有两条线路:一条工作线路和一条保护线路。两条线路总是活跃的。发送方多路复用器在**两条线路上都发送相同的数据** ； 接收方多路复用器监控线路井选择质量更好的那条线路。如果其中一条线路发生故障了，它丢失了信号，当然在接收方会选择另一条线路。虽然这种方案中会立即恢复故障，但是因为**需要两倍带宽**，所以这个方案的效率不高。注意一加一交换在**路径层**实现。

###### 一到一APS

在这个方案中，看起来像一加一方案，也有一条工作线路和一条保护线路。但是，数据通常只在工作线路上发送直到它发生故障。这时，接收方使**用反向线路通知发送方使用保护线路**。很明显，故障恢复比一加一方案慢，但是这个方案效率更高，因为**保护线路只有在工作线路发生故障时才会用来传输数据**。注意一到一交换在**线路层**实现。

###### 一到多 APS

这个方案与一到一方案相似，不同的是对于许多条工作线路，它**只有一条保护线路**。当其中一条工作线路发生故障时，**保护线路就会接管控制直到发生故障的线路被修复**。它没有一到一方案安全，因为如果多于一条工作线路同时发生故障，保护线路只能替换其中一条。注意一到多 APS在**线路层**实现。

#### 环状网络

ADM使得 SONET环状网络成为可能。
**SONET环可以用于单向或双向配置。**在每种情况下，我们可以**增加一个额外环使得网络能自我修复线路故障。**

##### 单向路径交换环

**单向路径交换环(unidirectional path switching ring , UPSR)** 是**有两个环的单网络**:一个环用做工作环而另一个用做保护环。这个主意与我们在线状网络中讨论过的一加一APS类似。**相同的信号从两个环都经过，一个顺时针而另一个逆时针。它称为 UPSR** ，是因为**监控在路径层实现**。一个节点在路径层接收到电信号的两个复本，比较它们，井选择质量更好的一个。如果两个ADM之间的环发生故障，另一个环仍然能保证数据流的继续。UPSR像一加一方案一样有快速的故障恢复，但是因为需要两个环来完成工作所以效率不高。一半的带宽被浪费掉了 。

![image-20231022101649298](assets/image-20231022101649298.png)
虽然我们在图中选择了一个发送方和三个接收方，但是有许多种其他配置。发送方使用两路连接来同时发送数据给两个环；接收方使用选择交换机来选择信号质量更好的环。我们使用一个 STS 多路复用器和三个 STS分离器来强调工作在路径层的节点。

##### 双向线路交换环

SONET环状网络的另一个方案是**双向线路交换环(bidirectional line switching ring , BLSR)** 。这种情况下，**通信是双向的**，这意味着我们**需要两个环来作为工作线路**。我们还**需要两个环作为保护线路**。这意味着**BLSR使用四个环**。但是工作机制与一到一APS方案类似。如果两个节点间一个方向的工作环发生故障，接收方节点可以使用反向环通知故障方向的上游节点使用保护环。网络能恢复许多种不同的故障，我们不在这讨论了。注意**BLSR 中故障恢复是在线路层而不是在路径层**。**ADM发现故障并通知邻近节点使用保护环**。
![image-20231022102012272](assets/image-20231022102012272.png)

##### 环的组合

今天SONET网络使用互连环的组合来提供广大区域的服务。例如，SONET网络可以有一个区域环、多个本地环和许多站点环来为广大区域提供服务。这些坏可以是UPSR 、BLSR 、或者两者的组合。图 17.23显示了这样一个广域环网络的概念。
![image-20231022102149170](assets/image-20231022102149170.png)

#### 网状网络

环网络的一个问题是缺乏扩展性。当环中的流量上升时，我们不仅需要升级线路也需要升级ADM。这种情况下，有多个交换机的网状网络有可能提供更好的性能。
**网状网络**中的交换机称为**交叉连接**。交叉连接像我们看到的其他交换机一样，有输入端口和输出端口。在输入端口，交换机接到一个OC-n信号，把它转换成一个STS-n信号，把它分解成相应的 STS-1 信号，并把每个STS-l 信号发送给正确的输出端口。输出端口接收到来自不同输入端口的 STS-1信号，把它们多路复用成一个 STS-n信号，并生成一个OC-n信号传输。图 17.24显示了一个网状SONET网络以及交换机的结构。
![image-20231022102250846](assets/image-20231022102250846.png)

### 虚拟支路

SONET设计用来承载宽带载荷。现在的数字体系的数据速率(DS-l 到 DS-3)比 STS-l 低。
为了使 SONET向后兼容现在的体系，它的帧设计包括了**虚拟支路(virtual tributaries , VT)**系统(见图 17.25) 。虚拟支路是能插入到 STS的部分载荷，井与其他部分载荷组合装入一个帧。**对于来自同一个源的数据，我们把SPE分割开来并称每一部分为VT** ，而不是使用 STS-l 帧的所有86个有效载荷列。
![image-20231022102702971](assets/image-20231022102702971.png)
当两个或更多支路被插入到单个 STS-1 帧中时，它们逐列交织。SONET提供了确定每个VT并把它们分开而无需分解整个流的机制。

## 电路网络:帧中继和ATM

**三种交换技术：电路交换、报文交换和分组交换。**

**分组交换可以使用两种方法:虚电路方法和数据报方法。**

两种常用的WAN技术使用虚电路交换。

1. **帧中继**是一种相对高速协议，它能提供一些在诸如DSL、有线TV和T线路等的其他WAN技术中没有的服务。 
2. **ATM**作为一种高速协议，当它部署诸如 SONET的物理层承载时，可以成为通信高速公路。

### 帧中继

**帧中继(Frame Relay) 是一种虚电路广域网**，帧中继（FrameRelay）是一种用于连接计算机系统的面向分组的通信方法。它主要用在公共或专用网上的局域网互联以及广域网连接。大多数公共电信局都提供帧中继服务，把它作为建立高性能的虚拟广域连接的一种途径。

**在帧中继之前**，一些组织使用一种称为 **X.25**的**虚电路交换网**，它在**网络层**中进行交换。

X.25的缺陷：

1. X.25具有 64Kbps 的低数据速率
2. X.25在数据链路层和网络层都提供了广泛的流量和差错控制。在这两个层中的流量和差错控制产生了大量的额外开销，并降低了传输率。对于在节点之间、源和目的地址之间传输的数据链路层的帧和网络层的分组，X.25都需要确认。
3. X.25最初设计用于个人应用，而不是因特网。X.25有自己的网络层。这意味着用户数据将被封装成X.25的网络层的分组。然而，因特网有自己的网络层，这就意味着，如果想要使用 X.25 ，因特网必须将自己的称为数据报的网络层分组交付给X.25封装成X.25 的分组。这是**双重的额外开销**。

一些组织开始从公共服务提供商那里租用 T-1 或T-3 线路组建自己的私有广域网。这种方法也有一些缺陷。

1. 如果一个组织有n个部门分布在一个地区，就需要n(n一 1)/2条T-1 或T-3 线路。尽管可能使用这些线路只有 10%的时间，但组织也必须为所有线路付费。这可能非常昂贵。
2. T-1和T-3线路提供的服务假定用户在所有时间都有固定的数据速率。例如，T-1 线路是为那些以固定的 1.544Mbps使用线路的用户而设计的。这种类型的服务井**不适合**现在的需要发送**突发性数据(bursty data)** 的许多用户。例如，一个用户可能想要以 6Mbps的速度发送数据2秒，7秒不发送，以 3 .44Mbps发送数据 1 秒，总共在 10秒内发送 15 .44M 比特。尽管平均速度仍然是 1.544Mbps ，但T-1 线路不能接受这种类型的需求，因为它是为固定速率的数据而不是为突发性数据而设计的。突发性数据需要**按需分配带宽**
   (bandwidth on demand) 。用户在不同的时间里可能需要不同的带宽分配。

帧中继是广域网，它有以下特征:

1. 帧中继以较高的速率( 1. 544Mbps以及最近的44.376Mbps) 工作。这就是说，它可以容易地代替网状的T-l或T-3线路。、
2. 帧中继只工作在物理层和数据链路层。这就是说，它可容易地用作主干网，为已经有一个网络层协议的协议提供服务，例如因特网
3. 帧中继允许突发性数据。
4. 帧中继允许的帧大小为9000字节，这适合于所有的局域网帧。
5. 帧中继比其他传统的广域网花费少。
6. 帧中继仅在数据链路层有错误检测，没有流量或错误控制。当一个帧被破坏时，它甚至没有一个重发策略，该帧只是简单地被丢弃。使用这种方式设计帧中继为更可靠的介质和在更高层上有流量和差错控制的协议提供更快的传输能力。

#### 结构

帧中继提供**永久虚电路**和**交换虚电路**。

图 18.1展示了一个连接到因特网的帧中继网络的例子。使用路由器来连接局域网和因特网中的广域网。在圈中，帧中继广域网作为全球因特网的一个链路。

![image-20231022104649946](assets/image-20231022104649946.png)

##### 虚电路

**帧中继是一种虚电路网络。**

帧中继的虚电路是用称为**数据链路连接标识符(data link connection identifier, DLCI)** 的一个数字来定义的。

在虚电路网络中，有两类编址:**全局的**和**本地的(虚电路标识符)**。
**全局编址**：源端或目的端需要有一个全局地址，该地址是一个广域网范围内或者国际范围内(如果这个广域网是一个国际网络的一个部分)唯一地址。然而，虚电路网络中的全局地址仅用于建立虚电路标识符，如下所述。
**虚电路标识符**：实际用于数据传输的标识符称为**虚电路标识符(virtual circuit identifier , VCI)**。与全局地址不同，一个VCI是一个仅在交换机范围内的小数字，由两个交换机之间的帧来使用。当一帧到达一个交换机时，它有一个VCI ，当它离开时，它有另一个VCI 。图 8.11 说明了数据帧中的 VCI从一个交换机到另一个交换机时是如何变化的。注意:既然每个交换机都可以使用自己唯一的 VCI 集，因此，
VCI 不必是一个大的数字。
![image-20231022105034015](assets/image-20231022105034015.png)

帧中继中的VCI称为 DLCI 。

##### 永久虚电脑和交换虚拟电路

源和目的地址可能选择拥有一条**永久虚电路(permanent virtual circuit, PVC)** 。这种情况下，连接建立就简单了。相应的表条目由管理员为所有的交换机建立(当然是远程地建立井且是电子化地建立)。**为源地址分配一个出的VCI ，为目的地址分配一个入的VCI** 。

PVC连接有两个缺点。首先，**花费大**，因为即使没有使用，连接的两方也需要为这个连接一直付费。其次，只在一个源地址和一个目的地址之间建立连接。如果源地址需要和多个目的地址连接，那么每个连接都需要一个PVC 。替代的方法是**交换虚电路(switched virtual circuit , SVC) 。SVC建立一个临时的、短的连接，该连接只存在于源地址和目的地址的数据传输过程中**。像第8章讨论的一样，**SVC需要一个连接建立阶段和连接终止阶段。**

##### 交换机

帧中继网络中的每个交换机都有一个用来路由帧的表。这个表将一个输入端口(DLCI组合)与一个输出端口(DLCI组合)相匹配，如我们在一般虚电路网络中描述的一样。区别仅是VCI被DLCI代替。

#### 帧中继层

![image-20231022110024956](assets/image-20231022110024956.png)

**帧中继只有物理层和数据链路层。**

**物理层**：帧中继中的物理层没有定义一个具体的协议。相反，它允许实现者使用可用的任何协议。帧中继支持任何可以被ANSI所识别的协议。

**数据链路层**
在数据链路层，帧中继使用一个简单协议，它**不支持流量控制和差错控制**。它只有一个**差错检测机制**。图 18.3给出了帧中继的帧的格式。地址字段定义了 DLCI和一些用于控制拥塞的位。

![image-20231022110152528](assets/image-20231022110152528.png)

各个字段的描述如下:

- 地址(DLCI) 字段(2字节)。第一个字节的前6位构成DLCI的第一部分。DLCI的第二部分使用第二个字节的前4位。这些位是**标准所定义的 10位数据链路连接标识符的一部分**。DLCI的功能前面已经讨论过。在本节的最后，我们将讨论扩展地址。
- 命令/响应(C/R) 。允许上层识别帧是命令还是响应。帧中继协议不用这一位。
- 扩展地址(EA). 扩展地址(EA) 位表明当前字节是否是地址的最后一个字节。EA为0表示后面还跟着另外一个地址字节。EA为 1 则意味着当前字节是地址的最后一个字节。
- 前向里式拥事通知(FECN) 。前向显式拥事通知(forward explicit congestion notification , FECN) 位可以由所经过路径中的任何一个交换机来设置，用来**表示在帧传输方向上出现了拥塞**。它通知目的站点发生了拥塞。用这种方式，目的站点知道可能将出现延迟或丢失分组。我们将在第24章讨论拥塞控制时讨论这一位的用法。
- 后向显式拥事通知(BECN). 后向里式拥事通知(backward explicit congestion notification , BECN) 位用于**表示在帧传输相反的方向上出现了拥塞**。它通知发送方发生了拥塞。用这种方式，发送方知道它应该放慢发送速度以防止丢失分组。我们将在第24章讨论拥塞控制时讨论这一位的用法。
- 可丢弃选择位(DE) 。可丢弃选择位(discard eligibility , DE) 指明帧的优先级。在紧急情况下，交换机可能需要丢弃一些帧来缓和瓶颈井防止网络由于过载而崩渝。当设置DE为 1 时，这个位通知网络当发生拥塞时就丢弃该帧。该位可以由帧的发送方(用户)设置，也可以由网络中任何一个交换机设置。

帧中继不提供流量和差错控制，这些必须由上层协议提供。

#### 扩展地址

为了增加DLCI的范围，帧中继地址从原先的2字节扩展到 3字节或4字节。图 18.4显示了不同的地址。注意，EA字段定义了字节数，在地址的最后一字节 EA为 1 ，在其他字节 EA为0 。注意，在3字节或4字节格式中，最后一位之前的位都设为0 。

![image-20231022110822884](assets/image-20231022110822884.png)

#### FRAD

为了处理从其他协议到达的帧，帧中继使用一种称为**帧中继组装器/分解器**(Frame Relay assembler/disassembler, **FRAD**)的设备。
FRAD对来自其他协议的帧进行组装和分解，使它们成为帧中继的帧。一个 FRAD可以作为独立的设备或交换机的一部分来实现。
![image-20231022110916162](assets/image-20231022110916162.png)

#### VOFR

帧中继网络提供一个称为**帧中继语音**(Voice Over Frame Relay , **VOFR**) 的选项，它通过网络发送语音。语音用 PCM数字化，然后压缩，其结果在网上作为数据帧发送。这个特性允许长距离廉价发送语音。然而请注意，语音的质量没有在电路交换网(如电话网)上好。另外，有时上面提到的可变延时也会破坏实时语音。

#### LMI

帧中继最初是为 PVC连接而设计的，所以没有提供控制与管理接口。**本地管理信息(Local management information , LMI)是为了提供更多的管理特性才在最近加到帧中继协议中的一个协议。**
LMI能特别提供 ：

1. 一个保活机制以检测是否有数据在传输。
2. 一个多播机制，允许一个本地终端系统向多个远程终端系统发送帧。
3. 一个允许一个终端系统检测一个交换机状态(例如，查看交换机是否拥塞)的机制。

#### 拥塞控制和服务质量

帧中继一个很好的特性是提供了拥事控制(congestion control) 和服务质量

### ATM

**异步传输模式(Asynchronous Transfer Mode , ATM) 是由 ATM论坛设计的信元中继(cell relay) 协议**，井被ITU-T采纳。 ATM和SONET的结合将允许世界上的网络之间高速互连。实际上，ATM可以被设想为信息超高速公路上的"高速公路"。

数据链路层的数据通信：

1. 帧网络
2. 混合网络通信
3. 信元网络
4. 异步TDM

**信元网络**
一个信元是一个固定大小的小数据单元。在信元网络(cell network)中，使用信元(cell )作为数据交换的基本单位，所有的数据都装载入相的信元中，这些信元可以按照完全可预测和统一的方式进行传输。当不同大小和格式的帧从分支网络到达信元网络时，它们被分割成相同大小的多个小数据单元，并装载入信元中。这些信元和其他信元多路复用井路由通过整个信元网络。由于每个信元大小相同并且都很小，因此避免了由于多路复用不同大小的帧所带来的问题。

**信元网络**使用**信元**作为数据交换的基本单位。**信元定义为一个小的、固定大小的信息块。**

这种情形的第二个优点是链路的高速率和小信元相结合，这意味着如果不考虑交织，从每条链路的信元将以近似连续流的方式到达各自的目的地(就像一部电影在大脑中看上去是连续的画面，而实际上是由一系列静止的图像所组成的)。在这种方法中，信元网络可以在双方完全没有意识到分段或复用的情况下，处理如电话呼叫等实时传输。

**异步TDM**
ATM使用**异步时分复用**处理来自不同通道的信元一一这就是为什么称为异步传输模式的理由。它使用固定大小的时隙(一个信元的大小).
**ATM复用器**使用来自任何输入通道的一个信元填充一个时隙，如果通道没有发送的信元，则时隙为空。

#### 结构

TM是信元交换网络。用户访问设备，称为端点(endpoint) ，通过用户到**网络接口(user-to-network interface , UNI)**连接到网络内部的交换机上，交换机通过网络到网络接口(network-to-network interface, NNI) 彼此连接。图 18.9显示了一个ATM网络的例子。

![image-20231022172242317](assets/image-20231022172242317.png)

##### 虚连接

两个端点之间的连接是通过**传输路径(TP) 、虚路径(VP) 和虚电路(VC)** 完成的。

**传输路径**(transmission path , TP) 是一个端点与一个交换机或者两个交换机之间的**物理连接**(电线、电缆、卫星等)。可将两个交换机看做两个城市，传输路径是直接连接两个城市的所有高速公路的集合。

**一个传输路径划分成几个虚路径**。**一个虚路径(virtual path , VP) 提供两个交换机之间的一条连接或连接的集合**。可将一条虚路径看做连接两个城市的一条高速公路。每条高速公路是一个虚路径，所有高速公路的集合是传输路径。

信元网络基于**虚电路**(virtual circuit , VC )。属于同一报文的所有信元沿着同一条虚电路传输，同时保持它们的原始次序直到到达目的地。可将虚电路看做高速公路的车道。图 18.17显示了传输路径(物理连接)、虚路径(捆在一起的虚电路的集合，因为它们的部分路径是相同的)和虚电路(逻辑上连接两个端点)之间的关系。

标识符，虚电路网络中，为了从一个端点路由数据到另一个端点，需要标识该虚连接。
为此， ATM设计者创建了一个两级的层次标识符:

1. 虚路径标识符(virtual path identifier, VPI)
2. 虚电路标识符(virtual circuit identifier, VCI)

VPI定义特定的VP ，而VCI定义VP中特定的VC ，VPI对捆绑(逻辑上)成一个VP的所有虚连接都是相同的。

一个虚连接由一对数字定义:VPI和VCI 。

**在一个典型的ATM网络中，大多数的交换机使用 VPI来路由。而处于网络边界的那些直接和端点设备交互的交换机，使用 VPI和VCI来路由。**

![image-20231022172908631](assets/image-20231022172908631.png)

##### 信元

ATM 网络中的基本数据单元称为信元。**一个信元只有53字节长度，其中 5个字节为头部，48个字节为有效载荷**(用户数据可能少于48个字节)。

ATM以信元为单位，信元具有固定的长度(53 bytes)，短且固定长度的信元给硬件进行高速交换创造了条件。

信元头部的大部分被VPI和VCI占用，它们定义了虚连接，信元通过虚连接可以从一个端点传送到一个交换机，或者从一个交换机传送到另一个交换机

![image-20231022173059960](assets/image-20231022173059960.png)

##### 连接建立与释放

像帧中继一样，ATM使用两种类型的连接：PVC和SVC 。

PVC：永久虚电路连接是由网络提供商建立的两个端点之间的连接。VPI和VCI是为了永久连接而定义的，它们的值输入到每个交换机的交换表中。

SVC：在交换虚电路连接中，当一个端点想要和另一个端点连接肘，必须建立一条新的虚电路。ATM本身无法做到这件事，需要网络层地址和另一个协议(如 IP) 的服务。该协议的信令机制利用两个端点的网络层地址做出一个连接请求。实际的机制依赖于网络层协议。

#### 交换

ATM使用交换机将信元从源端点路由到目的端点。交换机使用 VPI和VCI来路由信元。路由要求整个标识符。

VPI为 153 、VCI为67的信元到达交换机接口(端口)1 。交换机检查它的交换表。
该交换表每行存储六项信息:**到达接口号、输入 VPI 、输入VCI以及对应的输出接口号、新的 VPI和新的 VCI** 。交换机在表中找到接口 1 和VPI为 153及VCI为 67的表项，并发现对应的输出接口为 3 、VPI为 140和VCI为 92 0 改变信元头部的VPI和VCI为 140和92 ，并通过接口 3发送信元。
![image-20231022180918878](assets/image-20231022180918878.png)

#### ATM层

ATM标准定义了三个层，从上到下依次为:应用适配层、ATM层和物理层(见图 18.16) 。

![image-20231022180935891](assets/image-20231022180935891.png)

端点使用所有这三层，而交换机只使用底下的两层(见图 18.17 )。

![image-20231022181003919](assets/image-20231022181003919.png)

ATM最初的设计是基于 SONET作为物理层介质。

##### **ATM层**

ATM层
(ATM layer) 提供了路由、通信量管理、交换和复用服务。它按照以下方式处理输出通信:从AAL子层接收48字节的分段，然后通过添加 5 字节的头部将它们转换成53字节的信元(见图 18 . 18 )。
![image-20231022181123121](assets/image-20231022181123121.png)

**头部格式**：ATM使用两种格式的头部:一种用于用户到网络接口(UN I)信元，另一种用于网络到网络接口(NNI)信元。图 18.19以逐字节的形式显示了 ITU-T所建议的头部格式(每一行代表一个字节)。

![image-20231022181155248](assets/image-20231022181155248.png)

**一般流量控制**(GFC).4 位的GFC 字段在 UNI 层提供了流量控制。ITU-T认为 UNI级的流量控制。在NNI级中是不必要的，因此，在NNI 的头部中，这些位被添加到VPI 中。较长的 VPI 允许在 NNI级中定义更多的虚路径。这种附加的VPI的格式尚未定义。

**虚路径标识符(VPI)**：VPI在 UNI信元中是 8位的宇段，而在 NNI信元中是 12位的字段(

**虚电路标识符(VCI)**：VCI 在两种帧中都是 16位的字段。

**有效载荷类型(PT)** 。在 3位的 PT宇段中，第一个位定义了有效载荷是用户数据还是管理信息。最后2个位的解释取决于第一个位。

**信元丢失优先级(CLP)**。1 位的 CLP字段是用来提供拥塞控制的。只要还有 CLP为 0的信元存在，CLP设置为 1 的信元就必须保留。

**头部纠错码(HEC)。**HEC是对头部前4个字节计算出来的校验码，它是除数为 x^8^+x^2^+x+1的CRC码，用来纠正单个位错误和大部分的多个位错误。

##### 应用适配层

**应用适配层(application adaptation layer , AAL)** 设计用来支持两个ATM概念。首先，ATM必须接受任何类型的有效载荷，不论是数据帧还是位流。一个数据帧可能来自上层协议，这些协议发送给承载网络(如ATM) 的帧都有清晰的定义。一个很好的实例是因特网。 **ATM也必须携带多媒体有效载荷。它能接受连续位流，把它们分成块，然后在ATM层再封装成帧。AAL使用两个子层来完成这些任务。**

不论数据是数据帧还是位流，有效载荷都必须分割成**48字节**的分段以被信元携带。在目的端，这些分段需要重组以重新生成初始的有效载荷。
**AAL**定义了一个称为**分割与重组(segmentation and reassembly , SAR) 的子层**来做这个工作。在源端拆分，在目的端重组。

在 SAR 将数据拆分之前，必须**保证数据的完整性**。这个工作由一个称为**会聚子层(convergence sublayer, CS)** 的子层来完成

ATM定义了四个版本的AAL:AA L1、AAL2 、AAL3/4和AAL5 。

ATM的设计者提供了第五种 AAL子层，称为**简单有效适配层(simple andefficient adaptation layer , SEAL)** 。

### ATM局域网

ATM主要用于广域网(WAN ATM) ，然而，该技术也适用于局域网(ATM LAN) 。

#### ATM局域网体系结构

##### 纯ATM体系结构

在纯ATM体系结构中，用一台 ATM 交换机，来连接一个局域网中的多个工作站，其连接方式与多个工作站连接到一台以太网交换机的方
式完全一样。图 18.25说明了这种情况。

![image-20231022183032739](assets/image-20231022183032739.png)

按这种方式，工作站以ATM技术(155 Mbps和652 Mbps)中的两个标准速率之一进行数据交换。然而，工作站使用了虚路径标识符(virtual path identifier , VPI) 和虚连接标识符(virtual connection identifier , VCI) ，而不是源和目的地址。

这种方法有一个严重的缺陷。该系统需要完全从最基础的水平开始构建，现存的局域网不能升级为纯ATM局域网。

##### 继承局域同体系结构

第二种方法是将ATM技术用做连接传统LAN的主干网 

![image-20231022183915113](assets/image-20231022183915113.png)

##### 混合体系结构

混合体系结构局域网(mixed architecture LAN) 通过增加更多的与交换机直接相连的工作站的方式，允许将继承局域网逐步移植到 ATM局域网上。图 18.27说明了这种体系结构。

![image-20231022184008506](assets/image-20231022184008506.png)

#### 局域网仿真(LANE)

从表面上看，在局域网中应用 ATM技术似乎是非常自然的事情。然而，这种相似性只限于表面，实际上要实现这一点有许多问题需要解决，现将其归纳如下:

1. 无连接与面向连接。诸如以太网这样的传统局域网是应用无连接协议的。无论何时只要分组准备好了，一台工作站就可将其发送到另一台工作站。这里就没有连接建立和连接终止阶段。另一方面，ATM是一种面向连接的协议。一台要给另一台工作站发送信元的工作站应该首先建立连接，井且在所有的信元发送完毕之后终止该连接。
2. 物理地址与虚电路标识符。与第一个问题紧密联系的另一个问题是两者寻址间的差异。诸如以太网这样的无连接协议通过源地址和目的地址来确定分组的路由，而对于诸如ATM这样的面向连接的协议，则是通过虚连接标识符(VPI和 VCI)来确定信元的路由的。
3. 多播和广播传递。诸如以太网这样的传统局域网能多播和广播分组。一个工作站能给一组工作站或所有的工作站发送分组。然而，即使在ATM 网络中能实现一点对多点的连接，但要在它上面进行多播或广播也不容易。
4. 互操作性。在幌合体系结构中，一台连接到继承局域网的工作站应该能够与一台直接连接到ATM交换机的工作站进行通信。

**局域网仿真**(local area network emulation , **LANE**) 的方法可以解决上面所提到的问题，该方法允许一个混合体系结构中的多个工作站相互进行通信。该方法运用了仿真的思想。多个工作站可以使用一种无连接服务来模拟一种面向连接的服务。工作站将源地址和目的地址用于初始连接，然后运用 VPI和VCI进行寻址。而且，该方法还允许各工作站使用单播、多播和广播地址。最后，在帧通过交换机发送之前，该方主去使用继承格式将帧转换成ATM信元。

#### 客户/服务器模型

**局域网仿真客户(LEC)**
所有的ATM工作站都将局域网仿真客户(LAN emulation client , LEC) 软件安装在三个ATM协议之上。上层协议并没有意识到 ATM技术的存在。这些协议将其请求发送到 LEC ，以请求一种局域网服务，如运用 MAC单播、多播或广播地址进行的无连接数据传输服务。然而，LEC仅解析该请求，并将结果传递到服务器中。

**局域网仿真配置服务器(LECS)**

局域网仿真配置服务器(LAN emulation configuration server , LECS) 用于客户机和LANE之间的初始连接。服务器总是等待接收初始连接。它有一个公开的ATM地址，并且系统中每个客户端都知道该地址。

**局域网仿真服务器(LES)**
局域网仿真服务器(LAN emulation server , LES) 软件安装在 LES 上。当一台工作站根据物理地址接收到一个将要发送到另一台工作站的帧时，LEC就给LES发送一个特殊的帧。服务器就在源和目的工作站之间创建一条虚电路。此时源工作站就能使用这条虚电路(和相应的标识符)给目的工作站发送一个或多个帧。

**广播/未知服务器(BUS)**
多播和广播要求使用另一台称为广播/未知服务器(broadcast/unknown server, BUS)的服务器。如果一台工作站需要给一个工作站组或每台工作站发送一个帧时，它首先将该帧发送到 BUS 。该服务器具有到每台工作站的永久虚连接。此时该服务器就创建所接收帧的多个拷贝，井将其中一个拷贝发送到一组工作站或所有的工作站，来模拟多播或广播过程。该服务器还能通过将帧发送到每台工作站的方式来传递单播帧。在此情况下，目的地址是未知的。有时这样做比从LES获取连接标识符更为高效。

#### 具有客户/服务器的混合体系结构

图 18.29说明了一个说合体系结构ATM局域网中的客户机和服务器。图 18.29中，有三种类型的服务器连接到了 ATM交换机上(实际上，它们可以是交换机的一部分)。而且图中还有两种类型的客户机。设计用于发送和接收LANE通信的工作站A和工作站B直接与ATM交换机
相连。传统的继承局域网中的工作站C ， D , E , F , G和H都通过一个转换器连接到交换机上。这些转换器充当 LEC客户机，并代表它们所连接的工作站进行通信。

![image-20231022184627995](assets/image-20231022184627995.png)